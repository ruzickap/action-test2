name: build

on:
  workflow_dispatch:
    inputs:
      build:
        description: Build
        default: all, my_windows-10-enterprise-x64-eval-libvirt
        required: false
      PACKER_LOG:
        description: PACKER_LOG
        default: 0
        required: true
      ANSIBLE_DEBUG:
        description: ANSIBLE_DEBUG
        default: false
        required: true
      VAGRANT_LOG:
        description: VAGRANT_LOG
        default: warn
        required: true
      build_release_upload:
        description: Upload release to Vagrant Cloud
        default: false
        required: false
  push:
    paths:
      - .github/workflows/packer-templates.yml

jobs:
  build-boxes:
    name: "*"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        stage:
          - my_ubuntu-20.04-server-amd64-libvirt
          - my_windows-10-enterprise-x64-eval-libvirt
          - my_ubuntu-20.04-server-amd64-virtualbox
          - my_windows-10-enterprise-x64-eval-virtualbox

    steps:
      - name: Skip test
        if: ${{ matrix.stage != github.event.inputs.build && github.event_name != 'push' && ! contains(github.event.inputs.build, 'all') }}
        run: |
          set -x
          echo "${{ matrix.stage }} | ${{ github.event.inputs.build }} | ${{ github.event_name }}"
          echo "skip=true" >> $GITHUB_ENV

      - name: Test123
        if: env.skip != 'true' && github.event_name == 'workflow_dispatch'
        run: |
          set -x
          echo "PACKER_LOG=${{ github.event.inputs.PACKER_LOG }}" >> $GITHUB_ENV
          echo "ANSIBLE_DEBUG=${{ github.event.inputs.ANSIBLE_DEBUG }}" >> $GITHUB_ENV
          echo "VAGRANT_LOG=${{ github.event.inputs.VAGRANT_LOG }}" >> $GITHUB_ENV

      - name: Install packages
        if: env.skip != 'true'
        run: |
          set -x
          echo "${{ matrix.stage }} | ${{ github.event.inputs.build }}"
          echo "${{ matrix.stage }}"

      - name: Set environment variables from payload
        if: env.skip != 'true' && ( github.event_name == 'repository_dispatch' && github.event.client_payload )
        run: |
          echo "${{ matrix.stage }}"
          echo "$PACKER_LOG | $ANSIBLE_DEBUG | $VAGRANT_LOG"

      - name: Build image
        if: env.skip != 'true'
        run: |
          echo ${{ matrix.stage }}

      - name: Check the created box image
        if: env.skip != 'true' && contains( matrix.stage, 'virtualbox' )
        run: |
          echo ${{ matrix.stage }}

      - name: Upload box to Vagrant Cloud
        if: env.skip != 'true' && ( github.event_name == 'schedule' || ( github.event_name == 'repository_dispatch' && github.event.action == 'build_release_upload' ) )
        env:
          BOX_VERSION: ${{ env.BOX_VERSION }}
        run: |
          echo ${{ matrix.stage }}

  clean_check_versions:
    needs: build-boxes
    if: always()
    runs-on: ubuntu-20.04
    steps:
      - name: Remove old versions
        run: |
          echo "xxxx"
